<!DOCTYPE html>
<html>
  <head>
    <title>Raynee -つながる傘シェアリングサービス- </title>
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <meta name=”viewport” content=”width=device-width, initial-scale=1”>

    <%= stylesheet_link_tag    'application', media: 'all' %>
    <%= javascript_include_tag 'application' %>
  </head>

  <body>
    <header>
      <div class="header_block">
        <div class="header_left"><%= image_tag 'raynee_logo.png', class: "raynee-logo" %></div>
        <div class="header_center"></div>
        <% if user_signed_in? %>
          <div class="header_prof_img" id="dropdown__btn">
            <% if current_user.image.url == nil %>
              <% if current_user.gender == "男" %>
                <%= image_tag('male.png') %>
              <% elsif current_user.gender == "女" %>
                <%= image_tag('female.png') %>
              <% elsif current_user.gender == "どちらでもない" %>
                <%= image_tag('trans.png') %>
              <% end %>
            <% else %>
              <%= image_tag(current_user.image.url) unless current_user.image.url == nil %>
            <% end %>
          </div>
        <% else %>
          <% if controller.action_name == "new" && controller.controller_name == "registrations" %>
            <div class="header_right"><%= link_to "ログイン", new_user_session_path, class: "register_link" %></div>
          <% elsif controller.action_name == "new" && controller.controller_name == "sessions" %>
            <div class="header_right"><%= link_to "登録する", new_user_registration_path, class: "register_link" %></div>
          <% else %>
            <div class="header_right"><%= link_to "ログイン", new_user_session_path, class: "register_link" %></div>
          <% end %>
        <% end %>
      </div>

      <% if user_signed_in? %>
        <div class="dropdown_menu" id="header_menu">
          <div class="dropdown__body">
            <ul class="dropdown__list">
              <li class="dropdown__item">
                <%= link_to "マイページ", user_path(current_user.id), class: "dropdown__item-link" %>
              </li>
              <% if controller.action_name == "start" %>
                <li class="dropdown__item">
                  <%= link_to "スタート画面から始める", start_users_path, class: "dropdown__item-link" %>
                </li>
                <li class="dropdown__item">
                  <%= link_to "ログアウトして終了する", destroy_user_session_path, method: :delete, class: "dropdown__item-link" %>
                </li>
              <% elsif current_user.have_umbrella == true %>
                <li class="dropdown__item">
                  <%= link_to "スタート画面から始める", user_path(current_user.id, params: { user: { state: "restart"}}), data: { confirm: 'スタート画面に移動しますか？(リクエストが全て解除されます)' }, method: :put, class: "dropdown__item-link" %>
                </li>
                <li class="dropdown__item">
                  <%= link_to "ログアウトして終了する", destroy_user_session_path, method: :delete, data: { confirm: '本当に終了しますか？(リクエストが全て解除されます)' }, class: "dropdown__item-link" %>
                </li>
              <% elsif current_user.state == "restart" || current_user.state == nil || current_user.state == "start" || current_user.state == "broken" %>
                <li class="dropdown__item">
                  <%= link_to "スタート画面から始める", start_users_path, class: "dropdown__item-link" %>
                </li>
                <li class="dropdown__item">
                  <%= link_to "ログアウトして終了する", destroy_user_session_path, method: :delete, class: "dropdown__item-link" %>
                </li>
              <% elsif current_user.state == "request" || current_user.state == "message" %>
                <li class="dropdown__item">
                  <%= link_to "スタート画面から始める", user_path(current_user.id, params: { user: { state: "restart"}}), data: { confirm: 'スタート画面に移動しますか？(現在のリクエストがリセットされます)' }, method: :put, class: "dropdown__item-link" %>
                </li>
                <li class="dropdown__item">
                  <%= link_to "ログアウトして終了する", destroy_user_session_path, method: :delete, data: { confirm: '本当に終了しますか？(現在のリクエストがリセットされます)' }, class: "dropdown__item-link" %>
                </li>
              <% end %>
            </ul>
          </div>
          <div class="dropdown__empty" id="rest_of_dropdown"></div>
        </div>
      <% end %>
    </header>

    <main>
      <%= yield %>
    </main>

    <footer>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/jquery-autosize@1.18.18/jquery.autosize.min.js"></script>

    <% if controller.controller_name == "messages" %>
      <script>
        var element = document.documentElement;
        var bottom = element.scrollHeight - element.clientHeight;
        window.scroll(0, bottom);
      </script>
    <% end %>

    <script>
      (function () {
                    document.addEventListener('DOMContentLoaded', function() { // HTML解析が終わったら
                      const btn = document.getElementById('dropdown__btn'); // ボタンをidで取得
                      if(btn) { // ボタンが存在しないときにエラーになるのを回避
                        btn.addEventListener('click', function(){ //ボタンがクリックされたら
                          document.getElementById('header_menu').classList.toggle('is-open'); // is-openを付加する
                          //document.getElementById('rest_of_dropdown').classList.toggle('is-close'); // is-closeを付加する
                          this.classList.toggle('is-close'); // ボタンにis-closeを付加する
                        });
                      }
                      const restOfMenu = document.getElementById('rest_of_dropdown'); // メニューブロックの残りの部分をidで取得
                      if(restOfMenu) { // ボタンが存在しないときにエラーになるのを回避
                        restOfMenu.addEventListener('click', function(){ //メニューブロックの残りの部分がクリックされたら
                          document.getElementById('header_menu').classList.toggle('is-open'); // is-openを付加する
                          //document.getElementById('rest_of_dropdown').classList.toggle('is-close'); // is-closeを付加する
                          btn.classList.toggle('is-close'); // ボタンにis-closeを付加する
                        });
                      }
                    });
                  }());
    </script>

  </body>
</html>
